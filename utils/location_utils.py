#!/usr/bin/env python3
# -*- coding: utf-8 -*-

"""
Location utilities for the novel generator application.
Provides functions for location generation and management.
"""

import random
import logging
from typing import Dict, List, Any, Optional

# ロギングの設定
logger = logging.getLogger('novel_generator')

def generate_random_location() -> Dict[str, Any]:
    """
    ランダムな場所設定を生成する
    
    Returns:
        Dict[str, Any]: 場所情報の辞書
    """
    # 場所カテゴリと名前のマッピング
    categories = {
        "ホテル": [
            "グランドホテル", "パークホテル", "ホテルアゼリア", "シティホテル", 
            "ベイサイドホテル", "クラウンホテル", "インペリアルホテル", 
            "ラグジュアリーホテル", "東京ステーションホテル", "ヒルトンホテル"
        ],
        "アパート・マンション": [
            "サンライズマンション", "パークハイツ", "グリーンハイツ", "シティタワー", 
            "リバーサイドマンション", "スカイコート", "ガーデンハウス", 
            "フォレストヒルズ", "セントラルレジデンス", "ブルーハーバー"
        ],
        "オフィス": [
            "セントラルオフィス", "タワービル", "グランドビル", "ビジネスセンター", 
            "コーポレイトタワー", "ITパーク", "シティオフィス", 
            "スカイオフィス", "エンタープライズセンター", "テクノロジーセンター"
        ],
        "バー・クラブ": [
            "ムーンライト", "ブルームーン", "レッドルーム", "ナイトシャドウ", 
            "ザ・ラウンジ", "ウイスキーバー", "カルメン", 
            "スターダスト", "ブラックキャット", "ジャズバー"
        ],
        "カフェ・レストラン": [
            "カフェ・ド・パリ", "ガーデンカフェ", "カフェテラス", "リバーサイドカフェ", 
            "レストランパリ", "ビストロアンジュ", "トラットリアロマーナ", 
            "フレンチレストラン", "イタリアンダイニング", "和食処"
        ],
        "公園・自然": [
            "セントラルパーク", "グリーンパーク", "桜公園", "リバーサイドパーク", 
            "海浜公園", "フォレストガーデン", "ネイチャーリゾート", 
            "ボタニカルガーデン", "湖畔公園", "山間リゾート"
        ],
        "特殊場所": [
            "秘密の別荘", "隠れ家", "会員制クラブ", "プライベートルーム", 
            "秘密のアトリエ", "屋上テラス", "シークレットバー", 
            "地下室", "隠し部屋", "プライベートスパ"
        ]
    }
    
    # 雰囲気の種類
    atmospheres = [
        "高級で落ち着いた", "モダンでスタイリッシュな", "アンティークで歴史を感じる", 
        "暖かく親しみやすい", "ミステリアスで魅惑的な", "洗練された大人の", 
        "居心地の良い静かな", "エキゾチックな異国情緒あふれる", 
        "開放的で明るい", "シックで都会的な", "隠れ家的な秘密めいた"
    ]
    
    # 特徴の種類
    features = {
        "ホテル": [
            "広々としたキングサイズベッド", "窓からの素晴らしい景色", "高級アメニティ", 
            "大理石の豪華なバスルーム", "最上階のスイートルーム", "プライベートバルコニー", 
            "ルームサービス完備", "ミニバー", "ジャグジー付きの浴室", "防音設備の整った部屋"
        ],
        "アパート・マンション": [
            "広々としたリビングルーム", "モダンなキッチン", "大きな窓からの景色", 
            "プライベートバルコニー", "最新のセキュリティシステム", "静かな環境", 
            "豪華なバスルーム", "ウォークインクローゼット", "高い天井", "洗練されたインテリア"
        ],
        "オフィス": [
            "ガラス張りのパーティション", "最新のオフィス設備", "広々とした会議室", 
            "静かな個室", "素晴らしい街の景色", "モダンなデザイン", 
            "快適なソファーエリア", "高級感のあるインテリア", "昼夜を問わず利用可能", "セキュリティ万全"
        ],
        "バー・クラブ": [
            "暗めの照明と落ち着いた雰囲気", "高級感のあるカウンター", "プライベートVIPルーム", 
            "背の高いバースツール", "クラシックな木製の内装", "ライブミュージックステージ", 
            "ムーディな照明", "豊富なお酒のセレクション", "セミプライベートブース", "魅惑的なバーテンダー"
        ],
        "カフェ・レストラン": [
            "テラス席", "窓際の特等席", "プライベートダイニングルーム", 
            "オープンキッチン", "穏やかな音楽", "居心地の良いソファ席", 
            "アンティークな内装", "地元の食材を使った料理", "豊富なワインリスト", "落ち着いた照明"
        ],
        "公園・自然": [
            "鬱蒼とした木々", "静かな小道", "隠れた東屋", "穏やかな小川", 
            "美しい花々", "人目につかないベンチ", "古い橋", 
            "静かな池", "鳥のさえずり", "季節の草花"
        ],
        "特殊場所": [
            "秘密の入り口", "特別なアクセス方法", "限られた人のみ知る場所", 
            "豪華な内装", "特別な設備", "プライバシーが守られた空間", 
            "隠された仕掛け", "歴史的背景", "特別なサービス", "独特の雰囲気"
        ]
    }
    
    # ランダムにカテゴリを選択
    category = random.choice(list(categories.keys()))
    
    # カテゴリに基づいて名前を選択
    name = random.choice(categories[category])
    
    # ランダムに雰囲気を選択
    atmosphere = random.choice(atmospheres)
    
    # カテゴリに基づいて特徴を選択
    feature1 = random.choice(features[category])
    feature2 = random.choice([f for f in features[category] if f != feature1])
    feature_str = f"{feature1}と{feature2}が特徴的"
    
    # 場所の説明を生成
    descriptions = {
        "ホテル": [
            "都心にそびえ立つラグジュアリーホテル。上品なサービスと快適な環境が魅力。",
            "隠れ家的な高級ホテル。プライバシーが重視された空間設計。",
            "歴史ある老舗ホテル。クラシックな雰囲気とモダンな設備が融合。",
            "海や山を望む絶景リゾートホテル。自然に囲まれた贅沢な時間を提供。",
            "ビジネス街の中心にあるシティホテル。アクセスの良さと機能性が魅力。"
        ],
        "アパート・マンション": [
            "都心の高層マンション。最新設備と美しい夜景が自慢。",
            "閑静な住宅街にある低層マンション。プライバシーと静けさが魅力。",
            "リノベーションされた古いアパート。独特の魅力と現代的な機能性を兼ね備える。",
            "タワーマンションの最上階。街を一望する景色と贅沢な空間。",
            "ガーデン付きのテラスハウス。緑に囲まれた静かな暮らしを提供。"
        ],
        "オフィス": [
            "ガラス張りの近代的オフィスビル。最新技術を駆使した設備が整っている。",
            "歴史ある建物をリノベーションしたオフィス。伝統と革新が融合した空間。",
            "シェアオフィス・コワーキングスペース。様々な業種の人々が交流する場。",
            "企業の本社ビル。堅実さと威厳を感じさせるデザイン。",
            "クリエイティブな発想を促す開放的オフィス。革新的な企業文化を体現。"
        ],
        "バー・クラブ": [
            "大人のための高級バー。厳選された酒と洗練された雰囲気が魅力。",
            "ジャズが流れる落ち着いたバー。時間がゆっくり流れる特別な空間。",
            "隠れ家的なカクテルバー。バーテンダーの腕前が評判の秘密の場所。",
            "夜景が楽しめる高層階のスカイバー。特別な夜を演出する贅沢な空間。",
            "地下にある会員制バー。知る人ぞ知る秘密のラウンジ。"
        ],
        "カフェ・レストラン": [
            "朝から深夜まで営業するカフェ。様々な時間帯で異なる表情を見せる。",
            "本格的な料理を提供するレストラン。シェフの技術が光る特別な一皿。",
            "静かで落ち着いた雰囲気のカフェ。読書や仕事に最適な空間。",
            "季節の食材にこだわるビストロ。素材の味を生かした料理が評判。",
            "隠れ家的なダイニング。予約が取りにくい人気店。"
        ],
        "公園・自然": [
            "広大な都市公園。緑豊かな空間が都会の喧騒から解放してくれる。",
            "静かな湖畔の公園。水面に映る景色が美しい隠れた名所。",
            "季節の花々が楽しめる植物園。色とりどりの花が訪れる人を魅了する。",
            "古木が立ち並ぶ歴史ある公園。時間がゆっくり流れる癒しの空間。",
            "山の中腹にある展望公園。街を一望できる絶景スポット。"
        ],
        "特殊場所": [
            "知る人ぞ知る隠れ家。特別な招待がなければ訪れることができない秘密の場所。",
            "歴史的建造物の隠し部屋。かつての秘密の集会場として使われていた空間。",
            "屋上の特別なテラス。街の喧騒を忘れさせる贅沢なプライベート空間。",
            "地下に広がる秘密の空間。限られた人だけが知るもう一つの世界。",
            "プライベートクラブの特別室。非日常的な体験ができる特別な場所。"
        ]
    }
    
    # カテゴリに基づいて説明を選択
    description = random.choice(descriptions[category])
    
    # 場所情報を辞書にまとめる
    location = {
        'name': name,
        'category': category,
        'description': description,
        'atmosphere': f"{atmosphere}雰囲気",
        'features': feature_str,
        'tags': category
    }
    
    logger.info(f"ランダム場所生成: {name}({category})")
    
    return location

def generate_location_description(location: Dict[str, Any]) -> str:
    """
    場所情報から説明文を生成する
    
    Args:
        location: 場所情報の辞書
        
    Returns:
        str: 場所の説明文
    """
    name = location.get('name', '')
    category = location.get('category', '')
    description = location.get('description', '')
    atmosphere = location.get('atmosphere', '')
    features = location.get('features', '')
    
    full_description = f"{name}は{category}の一つ。"
    
    if description:
        full_description += f" {description}"
    
    if atmosphere:
        full_description += f" {atmosphere}で、"
    
    if features:
        full_description += f"{features}。"
    else:
        if full_description.endswith('、'):
            full_description = full_description[:-1] + "。"
    
    return full_description

def enrich_location(location: Dict[str, Any], prompt: Optional[str] = None) -> str:
    """
    場所設定を充実させるためのAIプロンプトを生成
    
    Args:
        location: 基本的な場所情報
        prompt: カスタムプロンプト (オプション)
        
    Returns:
        str: AIに渡すためのプロンプト
    """
    # デフォルトプロンプト
    default_prompt = f"""
あなたは小説の舞台設定の専門家です。以下の基本情報を元に、場所の雰囲気や特徴を充実させてください。

### 基本情報:
- 名前: {location.get('name', '')}
- カテゴリ: {location.get('category', '')}
- 説明: {location.get('description', '')}
- 雰囲気: {location.get('atmosphere', '')}
- 特徴: {location.get('features', '')}

### 指示:
- この場所の詳細な描写を追加してください
- 五感で感じられる要素（見た目、音、匂い、触感、味など）を含めてください
- この場所に独特の雰囲気やムードを描写してください
- この場所で起こりそうな出来事や、この場所に集まる人々について触れてください
- 官能小説の舞台として魅力的な要素を追加してください
"""
    
    if prompt:
        return prompt
    return default_prompt